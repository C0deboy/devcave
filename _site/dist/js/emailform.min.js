'use strict';

var formDataElements = {};

var inputs = document.querySelectorAll('.form-data');

inputs.forEach(function (el) {
  formDataElements[el.getAttribute('name')] = el;
});

var recaptcha = document.querySelector('.g-recaptcha');

var customErrors = {
  tooShort: function tooShort(fieldName, min) {
    return 'Pole ' + fieldName + ' musi zawierać co najmniej ' + min + ' znaki!';
  },
  tooLong: function tooLong(fieldName, max) {
    return 'Pole ' + fieldName + ' może zawierać co najwyżej ' + max + ' znaków!';
  },
  empty: function empty(fieldName) {
    return 'Pole ' + fieldName + ' nie może być puste!';
  },
  type: function type(fieldName) {
    return 'Pole ' + fieldName + ' jest niepoprawne!';
  },
  errorsInForm: 'W formularzu występują błędy!',
  recaptcha: 'Potwierdź, że nie jesteś robotem!'
};

var contactForm = $('#formularz-kontaktowy');
var formAlert = document.querySelector('.emailFormAlert');

function toggleContactForm(state) {
  if (typeof state !== 'boolean') throw new TypeError('State must be a boolean');

  if (state === true) {
    contactForm.fadeIn();
    contactForm.attr('aria-hidden', 'false');
    firstInput.focus();
  } else {
    contactForm.fadeOut();
    contactForm.attr('aria-hidden', 'true');

    for (var input in formDataElements) {
      formDataElements[input].value = '';
    }

    grecaptcha.reset();
    openContactBtn.focus();
  }
}

var closeContactBtn = $('#close-contact-btn');
var openContactBtn = $('#open-contact-btn');

openContactBtn.click(function () {
  toggleContactForm(true);
});

closeContactBtn.click(function () {
  toggleContactForm(false);
});

var firstInput = $('.form-data:first');

if (document.location.hash === '#formularz-kontaktowy') {
  openContactBtn.focus();
  openContactBtn.click();
}

closeContactBtn.on('keydown', function (e) {
  if (e.which === 9 && !e.shiftKey) {
    // tab
    e.preventDefault();
    firstInput.focus();
  }
});

firstInput.on('keydown', function (e) {
  if (e.which === 9 && e.shiftKey) {
    // tab
    e.preventDefault();
    closeContactBtn.focus();
  }
});

contactForm.on('keydown', function (e) {
  if (e.which === 27) {
    // esc
    toggleContactForm(false);
  }
});

$('.emailFormSubmit').click(function (event) {
  formAlert.innerHTML = '<i class="fa fa-spinner fa-pulse fa-2x fa-fw"></i>';
  event.preventDefault();

  var isValid = validateEmailForm();

  if (isValid === true) {
    var formData = {
      'g-recaptcha-response': grecaptcha.getResponse()
    };

    grecaptcha.reset();

    for (var el in formDataElements) {
      formData[el] = formDataElements[el].value;
    }

    var sendEmail = $.ajax({
      type: 'POST',
      url: '//formspree.io/lasota.marcinm@gmail.com',
      dataType: 'json',
      data: formData
    });

    sendEmail.fail(function (error) {
      console.log(error);
      formAlert.innerHTML = customErrors.errorsInForm;
    });

    sendEmail.done(function (response) {
      console.log(response);
      formAlert.innerHTML = 'Wysłano! Dzięki za wiadomość!';
    });
  } else {
    formAlert.innerHTML = customErrors.errorsInForm;
  }
});

function validateEmailForm() {
  var valid = true;
  for (var el in formDataElements) {
    var fieldName = formDataElements[el].parentElement.innerText;

    if (formDataElements[el].validity.valueMissing === true) {
      markWrongInput(formDataElements[el], customErrors.empty(fieldName));
    } else if (formDataElements[el].validity.tooShort === true) {
      var min = formDataElements[el].getAttribute('minlength');
      markWrongInput(formDataElements[el], customErrors.tooShort(fieldName, min));
    } else if (formDataElements[el].validity.tooLong === true) {
      var max = formDataElements[el].getAttribute('maxlength');
      markWrongInput(formDataElements[el], customErrors.tooLong(fieldName, max));
    } else if (formDataElements[el].validity.typeMismatch === true) {
      markWrongInput(formDataElements[el], customErrors.type(fieldName));
    }
    if (formDataElements[el].validity.valid === false) {
      valid = false;
    }
  }
  if (grecaptcha.getResponse().length === 0) {
    markWrongInput(recaptcha, customErrors.recaptcha);
    valid = false;
  }
  return valid;
}

function markWrongInput(wrongElement, alert) {
  if (wrongElement.classList.contains('wrongInput')) {
    return;
  }

  var errorMessageEl = document.createElement('p');
  errorMessageEl.classList.add('error');
  errorMessageEl.classList.add('wrongInput');
  errorMessageEl.textContent = alert;

  wrongElement.parentElement.append(errorMessageEl);
  wrongElement.classList.add('wrongInput');
  wrongElement.addEventListener('focus', clearErrors);
}

function clearErrors() {
  this.classList.remove('wrongInput');
  this.parentElement.removeChild(this.parentElement.getElementsByClassName('error')[0]);
  formAlert.innerHTML = '';
}

window.recaptchaClearErr = function () {
  document.querySelector('.g-recaptcha').focus();
};
