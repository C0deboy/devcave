<!DOCTYPE html>
<html lang="pl">
<head>
  
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Devcave - blog programisty na tematy związane z branżą IT, a szczególnie z programowaniem w Javie.">
<meta name="author" content="Codeboy">

<meta property="fb:pages" content="2221389098088691">
<meta property="og:title" content="Dodajemy formularz kontaktowy 5#">
<meta property="og:description" content="Sporo zmian, większa uniwersalność">

<title>Formularz kontaktowy - refaktoryzacja</title>

<link rel="canonical" href="https://devcave.pl/dajsiepoznac2017/formularz-kontaktowy-refaktoryzacja">
<link rel="shortcut icon" href="/img/devcave/logo.ico">


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-90973428-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-90973428-2');
</script>



<link rel="stylesheet" href="/dist/css/devcave.min.css">

<link href="//fonts.googleapis.com/css?family=Ubuntu" rel="stylesheet">
<link href='//fonts.googleapis.com/css?family=Open+Sans:300,600,800' rel='stylesheet' type='text/css'>

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link type="application/atom+xml" rel="alternate" href="https://devcave.pl/feed.xml" title="devcave.pl" />

</head>

<body>

<div class="navbar navbar-expand-lg navbar-light navbar-fixed-top navbar-custom">

    <a class="navbar-brand" href="/"><img src="/img/devcave/devcave.png" alt="logo"> devcave.pl</a>

    <button type="button" id="navbar-toggle-btn" class="navbar-toggler" data-toggle="collapse"
            data-target="#site-nav" aria-expanded="false" aria-controls="site-nav">

        Menu <i class="fa fa-bars" aria-hidden="true"></i>
    </button>

    <nav id="site-nav" class="collapse navbar-collapse">
        <ul class="nav navbar-nav ml-auto text-right">
            <li class="nav-item">
                <a class="nav-link" href="/o-mnie">O mnie</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/kontakt">Kontakt</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/archiwum">Archiwum</a>
            </li>
            <li class="nav-item">
                <a class="nav-link books-btn" href="/moja-biblioteka">Moja biblioteka</a>
            </li>
            <li class="nav-item">
                <button class="dark-mode-btn nav-link" data-toggle="tooltip" data-placement="bottom"
                        title="Zmień motyw">
                    <i class="fa fa-sun-o" aria-hidden="true"></i>/<i class="fa fa-moon-o" aria-hidden="true"></i>
                </button>
            </li>
        </ul>
    </nav>
</div>


<article>

  <div class="container post">
    <div class="row justify-content-center">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

        <header class="post-header">
          <div class="post-heading">

            <h1 class="post-title">Dodajemy formularz kontaktowy 5#</h1>
            
            <h2 class="post-subtitle">Sporo zmian, większa uniwersalność</h2>
            
            <p class="post-meta">
              
              18
              maja
              
              2017</p>
            <div class="tags">
              <div class="site-tag"><a href='/archiwum#dajsiepoznac2017'>DajSiePoznac2017</a></div>
              
            </div>

          </div>

          <hr>
        </header>

        
        <nav class="table-of-contents">
          <p class="m-0">Spis treści:</p>
          <ul class="section-nav">
<li class="toc-entry toc-h1"><a href="#zmiany">Zmiany</a></li>
<li class="toc-entry toc-h1"><a href="#javascript">Javascript</a></li>
<li class="toc-entry toc-h1"><a href="#php">PHP</a></li>
</ul>

          <hr>
        </nav>
        

        <p><u>W tym poście opisuję refaktoryzację naszego wcześniejszego formularza.</u></p>

<p>Jeśli trafiłeś tu bezpośrednio, zajrzyj do <a href="/dajsiepoznac2017/formularz-kontaktowy-HTML-JS">pierwszego postu</a>, gdzie opisuję założenia i tworzę podstawową strukturę formularza.</p>

<hX>Wpisy w tej serii:</hX>
<ol>
  <li><a href="/dajsiepoznac2017/formularz-kontaktowy-HTML-JS">HTML + otwieranie / zamykanie JQuery</a></li>
  <li><a href="/dajsiepoznac2017/formularz-kontaktowy-walidacja-ajax">Walidacja HTML5/JS + AJAX</a></li>
  <li><a href="/dajsiepoznac2017/formularz-kontaktowy-php-swiftmailer">Walidacja PHP + Swiftmailer</a></li>
  <li><a href="/dajsiepoznac2017/formularz-kontaktowy-dostepnosc">Dostępność formularza</a></li>
  <li><a href="/dajsiepoznac2017/formularz-kontaktowy-refaktoryzacja">Zrefaktoryzowana wersja + Github</a></li>
</ol>

<h1 id="zmiany">Zmiany</h1>

<p>Refaktoryzacja objęła zarówno stronę frontendową, jak i backendową. Kod jest teraz bardziej uniwersalny, łatwiejszy do modyfikacji. Stworzyłem dla niego również osobne <a href="https://github.com/C0deboy/Email-form">repozytorium</a> na GitHubie, gdzie znajdziesz najaktualniejszą wersję.</p>

<h1 id="javascript">Javascript</h1>

<p>Pobieranie oraz walidacja danych przebiega teraz automatycznie. Aby dodać nowe pole do formularza wystarczy dorzucić label wraz z inputem, który musi mieć klasę form-data. Wymagany jest też atrybut name. Opcjonalnie możemy dodać reguły walidacji HTML, które zostaną sprawdzone, czyli, np. min/maxlenght, required itd. Kompletne pole wygląda tak:</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;label</span> <span class="na">aria-live=</span><span class="s">"polite"</span><span class="nt">&gt;</span>
    Test
    <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">"form-data"</span> <span class="na">name=</span><span class="s">"test"</span> <span class="na">placeholder=</span><span class="s">"Test"</span> <span class="na">minlength=</span><span class="s">"4"</span> <span class="na">maxlength=</span><span class="s">"78"</span> <span class="na">required</span><span class="nt">&gt;</span>
<span class="nt">&lt;/label&gt;</span></code></pre></figure>

<p>Działa to w następujący sposób:</p>

<p>Elementy są pobierane automatycznie pętlą i tworzą obiekt JSON:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">const</span> <span class="nx">formDataElements</span> <span class="o">=</span> <span class="p">{};</span>

<span class="kd">const</span> <span class="nx">inputs</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="dl">'</span><span class="s1">.form-data</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">inputs</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">el</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">formDataElements</span><span class="p">[</span><span class="nx">el</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="dl">'</span><span class="s1">name</span><span class="dl">'</span><span class="p">)]</span> <span class="o">=</span> <span class="nx">el</span><span class="p">;</span>
<span class="p">});</span></code></pre></figure>

<p>Dzięki temu możemy w wygodny sposób operować na naszych elementach z wykorzystaniem pętli.</p>

<p class="note">
Używam tu anonimowych funkcji strzałkowych ( () =&gt; {} ), jest to składnia ES6. Są odpowiednikiem funkcji anonimowej w tradycyjnym zapisie: function () {}
</p>

<p>Nasze komunikaty o błędach teraz przechowywane są w jednym obiekcie JSON, aby można było je łatwiej modyfikować, a co najważniejsze, tylko w jednym miejscu. Dodatkowo posługuję się funkcjami strzałkowymi, które w czytelny sposób budują komunikat ze zmiennych podanych w ich parametrach.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">const</span> <span class="nx">customErrors</span> <span class="o">=</span> <span class="p">{</span>
    <span class="dl">'</span><span class="s1">tooShort</span><span class="dl">'</span><span class="p">:</span> <span class="p">(</span><span class="nx">fieldName</span><span class="p">,</span> <span class="nx">min</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="dl">"</span><span class="s2">Pole </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">fieldName</span> <span class="o">+</span> <span class="dl">"</span><span class="s2"> musi zawierać co najmniej </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">min</span> <span class="o">+</span> <span class="dl">"</span><span class="s2"> znaki!</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">tooLong</span><span class="dl">'</span><span class="p">:</span> <span class="p">(</span><span class="nx">fieldName</span><span class="p">,</span> <span class="nx">max</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="dl">"</span><span class="s2">Pole </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">fieldName</span> <span class="o">+</span> <span class="dl">"</span><span class="s2"> może zawierać co najwyżej </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">max</span> <span class="o">+</span> <span class="dl">"</span><span class="s2"> znaków!</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">empty</span><span class="dl">'</span><span class="p">:</span> <span class="p">(</span><span class="nx">fieldName</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="dl">"</span><span class="s2">Pole </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">fieldName</span> <span class="o">+</span> <span class="dl">"</span><span class="s2"> nie może być puste!</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">type</span><span class="dl">'</span><span class="p">:</span> <span class="p">(</span><span class="nx">fieldName</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="dl">"</span><span class="s2">Pole </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">fieldName</span> <span class="o">+</span> <span class="dl">"</span><span class="s2"> jest niepoprawne!</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">errorsInForm</span><span class="dl">'</span><span class="p">:</span> <span class="dl">"</span><span class="s2">W formularzu występują błędy!</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">recaptcha</span><span class="dl">'</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Potwierdź, że nie jesteś robotem!</span><span class="dl">"</span><span class="p">,</span>
<span class="p">};</span></code></pre></figure>

<p>Mniejsza zmiana dotknęła zamykania formularza, gdzie teraz wszystkie pola są czyszczone przez pętlę, a nie ręcznie:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="k">for</span> <span class="p">(</span><span class="kd">const</span> <span class="nx">input</span> <span class="k">in</span> <span class="nx">formDataElements</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">formDataElements</span><span class="p">[</span><span class="nx">input</span><span class="p">].</span><span class="nx">value</span> <span class="o">=</span> <span class="dl">''</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>oraz również wartości inputów do wysłania pobierane są pętlą (z wyjątkiem recaptcha):</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">const</span> <span class="nx">formData</span> <span class="o">=</span> <span class="p">{</span>
    <span class="dl">'</span><span class="s1">g-recaptcha-response</span><span class="dl">'</span><span class="p">:</span> <span class="nx">grecaptcha</span><span class="p">.</span><span class="nx">getResponse</span><span class="p">(),</span>
<span class="p">};</span>

<span class="k">for</span> <span class="p">(</span><span class="kd">const</span> <span class="nx">el</span> <span class="k">in</span> <span class="nx">formDataElements</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">formData</span><span class="p">[</span><span class="nx">el</span><span class="p">]</span> <span class="o">=</span> <span class="nx">formDataElements</span><span class="p">[</span><span class="nx">el</span><span class="p">].</span><span class="nx">value</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>Większa zmiana dotknęła też walidacji. Teraz sprawdzane jest każde pole osobno i komunikaty o błędach pojawią się pod każdym z nich. Nie tylko jeden pod przyciskiem “Wyślij”, tak jak było to wcześniej. Tam teraz pojawia się tylko ogólna informacja o (nie)powodzeniu wysłania wiadomości.</p>

<p>Wszystkie błędy, które przyjdą od strony PHP w postaci JSON, oznaczane są automatycznie z pomocą pętli:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">sendEmail</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">el</span> <span class="k">in</span> <span class="nx">error</span><span class="p">.</span><span class="nx">responseJSON</span><span class="p">.</span><span class="nx">errors</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">el</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">recaptcha</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">markWrongInput</span><span class="p">(</span><span class="nx">recaptcha</span><span class="p">,</span> <span class="nx">error</span><span class="p">.</span><span class="nx">responseJSON</span><span class="p">.</span><span class="nx">errors</span><span class="p">[</span><span class="nx">el</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="nx">markWrongInput</span><span class="p">(</span><span class="nx">formDataElements</span><span class="p">[</span><span class="nx">el</span><span class="p">],</span> <span class="nx">error</span><span class="p">.</span><span class="nx">responseJSON</span><span class="p">.</span><span class="nx">errors</span><span class="p">[</span><span class="nx">el</span><span class="p">]);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">formAlert</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">customErrors</span><span class="p">[</span><span class="dl">'</span><span class="s1">errorsInForm</span><span class="dl">'</span><span class="p">];</span>
<span class="p">});</span></code></pre></figure>

<p>Podobnie wygląda walidacja po stronie JS. Tu każde pole jest sprawdzane za pomocą HTML5 validation API dla określonych reguł oraz generowane są wcześniej utworzone przez nas komunikaty.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">validateEmailForm</span><span class="p">()</span> <span class="p">{</span>
	<span class="kd">let</span> <span class="nx">valid</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="kd">const</span> <span class="nx">el</span> <span class="k">in</span> <span class="nx">formDataElements</span><span class="p">)</span> <span class="p">{</span>
	    <span class="kd">const</span> <span class="nx">fieldName</span> <span class="o">=</span> <span class="nx">formDataElements</span><span class="p">[</span><span class="nx">el</span><span class="p">].</span><span class="nx">parentElement</span><span class="p">.</span><span class="nx">innerText</span><span class="p">;</span>

	    <span class="k">if</span> <span class="p">(</span><span class="nx">formDataElements</span><span class="p">[</span><span class="nx">el</span><span class="p">].</span><span class="nx">validity</span><span class="p">.</span><span class="nx">valueMissing</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
	        <span class="nx">markWrongInput</span><span class="p">(</span><span class="nx">formDataElements</span><span class="p">[</span><span class="nx">el</span><span class="p">],</span> <span class="nx">customErrors</span><span class="p">[</span><span class="dl">'</span><span class="s1">empty</span><span class="dl">'</span><span class="p">](</span><span class="nx">fieldName</span><span class="p">));</span>
	    <span class="p">}</span>
	    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">formDataElements</span><span class="p">[</span><span class="nx">el</span><span class="p">].</span><span class="nx">validity</span><span class="p">.</span><span class="nx">tooShort</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
	        <span class="kd">const</span> <span class="nx">min</span> <span class="o">=</span> <span class="nx">formDataElements</span><span class="p">[</span><span class="nx">el</span><span class="p">].</span><span class="nx">getAttribute</span><span class="p">(</span><span class="dl">'</span><span class="s1">minlength</span><span class="dl">'</span><span class="p">);</span>
	        <span class="nx">markWrongInput</span><span class="p">(</span><span class="nx">formDataElements</span><span class="p">[</span><span class="nx">el</span><span class="p">],</span> <span class="nx">customErrors</span><span class="p">[</span><span class="dl">'</span><span class="s1">tooShort</span><span class="dl">'</span><span class="p">](</span><span class="nx">fieldName</span><span class="p">,</span> <span class="nx">min</span><span class="p">));</span>
	    <span class="p">}</span>
	    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">formDataElements</span><span class="p">[</span><span class="nx">el</span><span class="p">].</span><span class="nx">validity</span><span class="p">.</span><span class="nx">tooLong</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
	        <span class="kd">const</span> <span class="nx">max</span> <span class="o">=</span> <span class="nx">formDataElements</span><span class="p">[</span><span class="nx">el</span><span class="p">].</span><span class="nx">getAttribute</span><span class="p">(</span><span class="dl">'</span><span class="s1">maxlength</span><span class="dl">'</span><span class="p">);</span>
	        <span class="nx">markWrongInput</span><span class="p">(</span><span class="nx">formDataElements</span><span class="p">[</span><span class="nx">el</span><span class="p">],</span> <span class="nx">customErrors</span><span class="p">[</span><span class="dl">'</span><span class="s1">tooLong</span><span class="dl">'</span><span class="p">](</span><span class="nx">fieldName</span><span class="p">,</span> <span class="nx">max</span><span class="p">));</span>
	    <span class="p">}</span>
	    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">formDataElements</span><span class="p">[</span><span class="nx">el</span><span class="p">].</span><span class="nx">validity</span><span class="p">.</span><span class="nx">typeMismatch</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
	        <span class="nx">markWrongInput</span><span class="p">(</span><span class="nx">formDataElements</span><span class="p">[</span><span class="nx">el</span><span class="p">],</span> <span class="nx">customErrors</span><span class="p">[</span><span class="dl">'</span><span class="s1">type</span><span class="dl">'</span><span class="p">](</span><span class="nx">fieldName</span><span class="p">));</span>
	    <span class="p">}</span>
	    <span class="k">if</span> <span class="p">(</span><span class="nx">formDataElements</span><span class="p">[</span><span class="nx">el</span><span class="p">].</span><span class="nx">validity</span><span class="p">.</span><span class="nx">valid</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
	        <span class="nx">valid</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="nx">grecaptcha</span><span class="p">.</span><span class="nx">getResponse</span><span class="p">().</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nx">markWrongInput</span><span class="p">(</span><span class="nx">recaptcha</span><span class="p">,</span> <span class="nx">customErrors</span><span class="p">[</span><span class="dl">'</span><span class="s1">recaptcha</span><span class="dl">'</span><span class="p">]);</span>
	    <span class="nx">valid</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">valid</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>Zmianie uległa także nasza funkcja oznaczająca niepoprawne pola. Teraz tworzy i dodaje komunikat pod niepoprawnym polem.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">markWrongInput</span><span class="p">(</span><span class="nx">wrongElement</span><span class="p">,</span> <span class="nx">alert</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">wrongElement</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="dl">'</span><span class="s1">wrongInput</span><span class="dl">'</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">const</span> <span class="nx">errorMessageEl</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="dl">'</span><span class="s1">p</span><span class="dl">'</span><span class="p">);</span>
    <span class="nx">errorMessageEl</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="dl">"</span><span class="s2">error</span><span class="dl">"</span><span class="p">);</span>
    <span class="nx">errorMessageEl</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="dl">'</span><span class="s1">wrongInput</span><span class="dl">'</span><span class="p">);</span>
    <span class="nx">errorMessageEl</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">alert</span><span class="p">;</span>

    <span class="nx">wrongElement</span><span class="p">.</span><span class="nx">parentElement</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">errorMessageEl</span><span class="p">);</span>
    <span class="nx">wrongElement</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="dl">'</span><span class="s1">wrongInput</span><span class="dl">'</span><span class="p">);</span>
    <span class="nx">wrongElement</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">focus</span><span class="dl">"</span><span class="p">,</span> <span class="nx">clearErrors</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>I jak widać, odseparowałem funkcję do czyszczenia błędów, która jest uruchamiana, gdy pole uzyska focus:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">clearErrors</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="dl">'</span><span class="s1">wrongInput</span><span class="dl">'</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">parentElement</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">parentElement</span><span class="p">.</span><span class="nx">getElementsByClassName</span><span class="p">(</span><span class="dl">'</span><span class="s1">error</span><span class="dl">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="nx">formAlert</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="dl">''</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>Osobno na callbacku od recaptchy musiałem podpiąć dla niej focus (tabindex wymagany), co aktywuje funkcję czyszczącą komunikat (clearErrors):</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html"><span class="c">&lt;!--...--&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"g-recaptcha"</span> <span class="na">tabindex=</span><span class="s">"-1"</span> <span class="na">data-sitekey=</span><span class="s">"6LevbxMUAAAAAIa8dsrFNJn0S_b_t5K8INV4z2JD"</span>
                 <span class="na">data-callback=</span><span class="s">"RecaptchaClearMsg"</span><span class="nt">&gt;&lt;/div&gt;</span>
<span class="c">&lt;!--...--&gt;</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">RecaptchaClearMsg</span><span class="p">()</span> <span class="p">{</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="dl">'</span><span class="s1">.g-recaptcha</span><span class="dl">'</span><span class="p">).</span><span class="nx">focus</span><span class="p">();</span>
<span class="p">}</span></code></pre></figure>

<h1 id="php">PHP</h1>

<p>Tu też sporo zmian. Podpiąłem <a href="https://getcomposer.org/">Composera</a> do zarządzania zależnościami. Do walidacji stworzona jest funkcja korzystająca z zewnętrznego narzędzia do walidacji danych: <a href="https://github.com/Respect/Validation">Respect Validation</a>. Błędy przechowywane są teraz w tablicy, a email zostanie wysłany tylko wtedy, gdy będzie pusta:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nf">validateContactForm</span><span class="p">(</span><span class="k">array</span> <span class="nv">$form</span><span class="p">)</span><span class="o">:</span> <span class="k">array</span>
<span class="p">{</span>
    <span class="nv">$errors</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nv">$rules</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">'userEmail'</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="k">new</span> <span class="nx">Validator</span><span class="p">())</span><span class="o">-&gt;</span><span class="na">addRules</span><span class="p">([</span><span class="k">new</span> <span class="nx">NotEmpty</span><span class="p">(),</span> <span class="k">new</span> <span class="nx">Email</span><span class="p">()]),</span>
        <span class="s1">'subject'</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="k">new</span> <span class="nx">Validator</span><span class="p">())</span><span class="o">-&gt;</span><span class="na">addRules</span><span class="p">([</span><span class="k">new</span> <span class="nx">NotEmpty</span><span class="p">(),</span> <span class="k">new</span> <span class="nx">StringType</span><span class="p">(),</span> <span class="k">new</span> <span class="nx">Length</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">78</span><span class="p">)]),</span>
        <span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="k">new</span> <span class="nx">Validator</span><span class="p">())</span><span class="o">-&gt;</span><span class="na">addRules</span><span class="p">([</span><span class="k">new</span> <span class="nx">NotEmpty</span><span class="p">(),</span> <span class="k">new</span> <span class="nx">StringType</span><span class="p">(),</span> <span class="k">new</span> <span class="nx">Length</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6000</span><span class="p">)]),</span>
    <span class="p">];</span>
    <span class="nv">$validationMessages</span> <span class="o">=</span> <span class="p">(</span><span class="k">require_once</span> <span class="nx">__DIR__</span> <span class="o">.</span> <span class="s1">'/settings.php'</span><span class="p">)[</span><span class="s1">'validationMessages'</span><span class="p">];</span>

    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$rules</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$validator</span><span class="p">)</span> <span class="p">{</span>
        <span class="cd">/** @var $validator Validator */</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nv">$validator</span><span class="o">-&gt;</span><span class="na">setName</span><span class="p">(</span><span class="nv">$key</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">assert</span><span class="p">(</span><span class="nv">$form</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">??</span> <span class="kc">null</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">NestedValidationException</span> <span class="nv">$exception</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$exception</span><span class="o">-&gt;</span><span class="na">findMessages</span><span class="p">(</span><span class="nv">$validationMessages</span><span class="p">);</span>
            <span class="nv">$errors</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$exception</span><span class="o">-&gt;</span><span class="na">getMessages</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">validateReCaptcha</span><span class="p">(</span><span class="nv">$form</span><span class="p">[</span><span class="s1">'g-recaptcha-response'</span><span class="p">]</span> <span class="o">??</span> <span class="s1">''</span><span class="p">)</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$errors</span><span class="p">[</span><span class="s1">'recaptcha'</span><span class="p">][]</span> <span class="o">=</span> <span class="s2">"Potwierdź, że nie jesteś robotem!"</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$errors</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Plik konfiguracyjny <span class="file">settings.php</span> został wzbogacony o treści komunikatów, które są podmieniane z tymi z RespectValidation:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">return</span> <span class="p">[</span>
    <span class="s1">'reCaptcha'</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">'secret'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="s1">'mailer'</span>    <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">'host'</span>     <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
        <span class="s1">'port'</span>     <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
        <span class="s1">'username'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
        <span class="s1">'password'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
        <span class="s1">'email'</span>    <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="s1">'validationMessages'</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">'stringType'</span><span class="o">=&gt;</span> <span class="s1">'Musi być typu string'</span><span class="p">,</span>
        <span class="s1">'length'</span>    <span class="o">=&gt;</span> <span class="s1">'Musi zawierać od  do  znaków'</span><span class="p">,</span>
        <span class="s1">'email'</span>     <span class="o">=&gt;</span> <span class="s1">'Niepoprawny email'</span><span class="p">,</span>
        <span class="s1">'notEmpty'</span>  <span class="o">=&gt;</span> <span class="s1">'Pole nie może być puste'</span><span class="p">,</span>
        <span class="s1">'NotSent'</span>   <span class="o">=&gt;</span> <span class="s1">'Coś poszło nie tak :('</span><span class="p">,</span>
        <span class="s1">'Sent'</span>      <span class="o">=&gt;</span> <span class="s1">'Wysłano! Dzięki za wiadomość'</span>
    <span class="p">],</span>
<span class="p">];</span>
</code></pre></div></div>
<p>Cały kod został również podzielony na osobne funkcje, z drobnymi modyfikacjami:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nf">validateReCaptcha</span><span class="p">(</span><span class="nx">string</span> <span class="nv">$code</span><span class="p">)</span><span class="o">:</span> <span class="nx">bool</span>
<span class="p">{</span>
    <span class="nv">$url</span> <span class="o">=</span> <span class="s1">'https://www.google.com/recaptcha/api/siteverify?'</span> <span class="o">.</span> <span class="nb">http_build_query</span><span class="p">([</span>
            <span class="s1">'secret'</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="k">require</span> <span class="nx">__DIR__</span> <span class="o">.</span> <span class="s1">'/settings.php'</span><span class="p">)[</span><span class="s1">'reCaptcha'</span><span class="p">][</span><span class="s1">'secret'</span><span class="p">],</span>
            <span class="s1">'response'</span> <span class="o">=&gt;</span> <span class="nv">$code</span><span class="p">,</span>
        <span class="p">]);</span>
    <span class="nv">$content</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>
    <span class="nv">$response</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nv">$content</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="k">return</span> <span class="nv">$response</span><span class="p">[</span><span class="s1">'success'</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">getMailer</span><span class="p">()</span><span class="o">:</span> <span class="nx">Swift_Mailer</span>
<span class="p">{</span>
    <span class="nv">$config</span> <span class="o">=</span> <span class="p">(</span><span class="k">require</span> <span class="nx">__DIR__</span> <span class="o">.</span> <span class="s1">'/settings.php'</span><span class="p">)[</span><span class="s1">'mailer'</span><span class="p">];</span>

    <span class="nv">$transport</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Swift_SmtpTransport</span><span class="p">(</span><span class="nv">$config</span><span class="p">[</span><span class="s1">'host'</span><span class="p">],</span> <span class="nv">$config</span><span class="p">[</span><span class="s1">'port'</span><span class="p">]);</span>
    <span class="nv">$transport</span><span class="o">-&gt;</span><span class="na">setUsername</span><span class="p">(</span><span class="nv">$config</span><span class="p">[</span><span class="s1">'username'</span><span class="p">]);</span>
    <span class="nv">$transport</span><span class="o">-&gt;</span><span class="na">setPassword</span><span class="p">(</span><span class="nv">$config</span><span class="p">[</span><span class="s1">'password'</span><span class="p">]);</span>

    <span class="k">return</span> <span class="k">new</span> <span class="nx">Swift_Mailer</span><span class="p">(</span><span class="nv">$transport</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">prepareMail</span><span class="p">(</span><span class="k">array</span> <span class="nv">$params</span><span class="p">)</span><span class="o">:</span> <span class="nx">Swift_Message</span>
<span class="p">{</span>
    <span class="nv">$config</span> <span class="o">=</span> <span class="p">(</span><span class="k">require</span> <span class="nx">__DIR__</span> <span class="o">.</span> <span class="s1">'/settings.php'</span><span class="p">)[</span><span class="s1">'mailer'</span><span class="p">];</span>

    <span class="nv">$mail</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Swift_Message</span><span class="p">(</span>
        <span class="nv">$params</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">],</span>
        <span class="nv">$params</span><span class="p">[</span><span class="s1">'message'</span><span class="p">],</span>
        <span class="s1">'text/plain'</span><span class="p">,</span>
        <span class="s1">'UTF-8'</span>
    <span class="p">);</span>

    <span class="nv">$mail</span><span class="o">-&gt;</span><span class="na">setFrom</span><span class="p">(</span><span class="nv">$params</span><span class="p">[</span><span class="s1">'userEmail'</span><span class="p">]);</span>
    <span class="nv">$mail</span><span class="o">-&gt;</span><span class="na">setReplyTo</span><span class="p">(</span><span class="nv">$params</span><span class="p">[</span><span class="s1">'userEmail'</span><span class="p">]);</span>
    <span class="nv">$mail</span><span class="o">-&gt;</span><span class="na">setTo</span><span class="p">(</span><span class="nv">$config</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]);</span>

    <span class="k">return</span> <span class="nv">$mail</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">sendMail</span><span class="p">(</span><span class="k">array</span> <span class="nv">$params</span><span class="p">)</span><span class="o">:</span> <span class="nx">bool</span>
<span class="p">{</span>
    <span class="nv">$mailer</span> <span class="o">=</span> <span class="nx">getMailer</span><span class="p">();</span>
    <span class="k">return</span> <span class="nv">$mailer</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span><span class="nx">prepareMail</span><span class="p">(</span><span class="nv">$params</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<p>A obsługa wysłania formularza znajduję się w osobnym pliku <span class="file">ajaxsend.php</span>:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">require_once</span> <span class="nx">__DIR__</span> <span class="o">.</span> <span class="s1">'/functions.php'</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$errors</span> <span class="o">=</span> <span class="nx">validateContactForm</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">))</span> <span class="p">{</span>
    <span class="nb">http_response_code</span><span class="p">(</span><span class="mi">400</span><span class="p">);</span>
    <span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: application/json'</span><span class="p">);</span>
    <span class="k">echo</span> <span class="nb">json_encode</span><span class="p">([</span><span class="s1">'errors'</span> <span class="o">=&gt;</span> <span class="nv">$errors</span><span class="p">]);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">sendMail</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">))</span> <span class="p">{</span>
        <span class="nb">http_response_code</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
        <span class="k">echo</span> <span class="nb">json_encode</span><span class="p">([</span><span class="s1">'status'</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="k">require</span> <span class="nx">__DIR__</span> <span class="o">.</span> <span class="s1">'/settings.php'</span><span class="p">)[</span><span class="s1">'validationMessages'</span><span class="p">][</span><span class="s1">'Sent'</span><span class="p">]]);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nb">http_response_code</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
        <span class="k">echo</span> <span class="nb">json_encode</span><span class="p">([</span><span class="s1">'status'</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="k">require</span> <span class="nx">__DIR__</span> <span class="o">.</span> <span class="s1">'/settings.php'</span><span class="p">)[</span><span class="s1">'validationMessages'</span><span class="p">][</span><span class="s1">'NotSent'</span><span class="p">]]);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Całość prezentuję się w następujący sposób:</p>

<script async="" src="//jsfiddle.net/C0deboy/Lmjmmyfc/embed/result,js,html,css/dark/"></script>



      </div>
    </div>
  </div>

</article>

<div class="container d-print-none">
  <div class="row justify-content-center">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <hr>

      <ul class="pagination">
        
        <li class="page-item">
          <a class="page-link box-effect" href="/dajsiepoznac2017/matura-informatyka-przydatne-funkcje-w-javie"
             data-toggle="tooltip" data-animation="zoom" data-delay="50" title="Matura z informatyki - przydatne funkcje - Java"><i class="fa fa-arrow-left"
                                                                                                            aria-hidden="true"></i>
            Poprzedni post</a>
        </li>
        
        
        <li class="page-item ml-auto">
          <a class="page-link box-effect" href="/dajsiepoznac2017/npm-zaleznosci-i-ESLint"
             data-toggle="tooltip" data-animation="zoom" data-delay="50" title="NPM i ESLint">Następny post <i
                  class="fa fa-arrow-right" aria-hidden="true"></i></a>
        </li>
        
      </ul>

      <div class="text-center">
    <p class="text-center">Jeśli uważasz, że to co robię jest przydatne, polub stronę bloga na Facebooku. Wrzucam tam m.in. informacje o nowych wpisach, o promocjach dla programistów i inne.</p>

    <div class="fb-page inline box-effect">
        <iframe
            src="https://www.facebook.com/plugins/page.php?href=https%3A%2F%2Fwww.facebook.com%2Fdevcavepl&tabs&width=340&height=130&small_header=false&adapt_container_width=true&hide_cover=false&show_facepile=false&appId"></iframe>
    </div>
</div>

      <div class="text-center recommended">
    <div class="box-effect books-ad ">
        <a href="https://jaki-jezyk-programowania.pl/ksiazki">
            <img src="/img/reuse/books.png" alt="książki"/>
            <h3>Zobacz polecane książki</h3>
        </a>
    </div>

    <div class="box-effect books-ad ">
        <a href="https://jaki-jezyk-programowania.pl/kursy">
            <img src="/img/reuse/video-courses.png" alt="video kursy"/>
            <h3>Zobacz polecane video kursy</h3>
        </a>
    </div>
</div>

      <hr>

      

<div id="disqus_thread"></div>
<script>
  const disqus_config = function () {
    this.page.url = "https://devcave.pl/dajsiepoznac2017/formularz-kontaktowy-refaktoryzacja";
    this.page.identifier = "/dajsiepoznac2017/formularz-kontaktowy-refaktoryzacja";
  };

  (function () { // DON'T EDIT BELOW THIS LINE
    const d = document, s = d.createElement('script');
    s.src = 'https://jaki-jezyk-programowania.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Włacz JavaScript w twojej przeglądarce, aby zobaczyć <a href="https://disqus.com/?ref_noscript"> komentarze by
    Disqus.</a></noscript>



    </div>
  </div>
</div>

<hr>

<script src="/promotion/promotion.js"></script>



<footer class="d-print-none">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center social-buttons">
                    <li class="list-inline-item">
                        <a class="main-btn" href="/feed.xml" data-toggle="tooltip" data-animation="zoom" data-delay="50" title="RSS">
                            <i class="fa fa-rss fa-lg"></i>
                        </a>
                    </li>
                    <li class="list-inline-item">
                        <a class="main-btn" href="https://www.linkedin.com/in/marcin-lasota/" data-toggle="tooltip" data-animation="zoom" data-delay="50" title="LinkedIn">
                            <i class="fa fa-linkedin-square" aria-hidden="true"></i>
                        </a>
                    </li>
                    <li class="list-inline-item">
                        <a class="main-btn" href="https://github.com/C0deboy" data-toggle="tooltip" data-animation="zoom" data-delay="50" title="Github">
                            <i class="fa fa-github fa-lg"></i>
                        </a>
                    </li>
                    <li class="list-inline-item">
                        <a class="main-btn" href="mailto:lasota.marcinm@gmail.com" data-toggle="tooltip" data-animation="zoom" data-delay="50" title="lasota.marcinm@gmail.com">
                            <i class="fa fa-envelope fa-lg"></i>
                        </a>
                    </li>
                </ul>
                <p class="copyright text-muted">Copyright <i class="fa fa-copyright" aria-hidden="true"></i> devcave 2017 - 2020</p>
            </div>
        </div>
    </div>
</footer>

<script src="/dist/js/devcave.min.js"></script>


</body>

</html>
